name: _

on:
  workflow_call:
    # inputs: 
    #   createrelease:
    #     type: boolean
    #     default: false
    #     required: false 
jobs:
  buildall:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: win10
            pythonversion: '3.13.11'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pythonversion }}
          architecture: ${{ matrix.arch }}

      - name: Generate app icon from logo.png
        shell: powershell
        run: |
          python -m pip install --upgrade pip pillow
          @'
from PIL import Image
src = r"src/files/static/logo.png"
dst = r"src/NativeImpl/exec/luna.ico"
im = Image.open(src).convert("RGBA")
sizes = [(256,256),(128,128),(64,64),(48,48),(32,32),(24,24),(16,16)]
im.save(dst, format="ICO", sizes=sizes)
print(f"generated {dst}")
'@ | python -

      - run: C:\hostedtoolcache\windows\Python\3.13.11\x64\python src/scripts/build_lunatranslator.py cpp ${{ matrix.arch }} ${{ matrix.target }}
      - run: C:\hostedtoolcache\windows\Python\3.13.11\x64\python src/scripts/build_lunatranslator.py hook ${{ matrix.arch }} ${{ matrix.target }}
      - run:  C:\hostedtoolcache\windows\Python\3.13.11\x64\python src/scripts/build_lunatranslator.py pyrt ${{ matrix.arch }} ${{ matrix.pythonversion }} ${{ matrix.target }}
      - run:  C:\hostedtoolcache\windows\Python\3.13.11\x64\python src/scripts/build_lunatranslator.py merge ${{ matrix.arch }} ${{ matrix.target }}

      - uses: actions/upload-artifact@v4
        with:
          name: LunaTranslator_${{ matrix.arch }}_${{ matrix.target }}
          path: src/build/LunaTranslator_${{ matrix.arch }}_${{ matrix.target }}

      # - uses: actions/attest-build-provenance@v2.2.0
      #   with:
      #       subject-path: src/build/LunaTranslator_${{ matrix.arch }}_${{ matrix.target }}

  signandrepack:
    runs-on: windows-latest
    needs: [buildall]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
            path: build
      - run: python src/scripts/build_lunatranslator.py exedlls

      - name: Self-sign EXE/DLL (no third-party service)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          # Mirror collect -> signed_exedlls to keep existing repack logic unchanged
          Copy-Item -Path "collect" -Destination "signed_exedlls" -Recurse -Force

          # Create temporary self-signed code-signing certificate
          $cert = New-SelfSignedCertificate `
            -Type CodeSigningCert `
            -Subject "CN=LunaTranslator Self-Signed CI" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -NotAfter (Get-Date).AddYears(2)

          # Locate signtool from Windows SDK
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName

          if (-not $signtool) {
            throw "signtool.exe not found"
          }

          # Sign all .exe/.dll files in signed_exedlls
          Get-ChildItem "signed_exedlls" -Recurse -File |
            Where-Object { $_.Extension -in ".exe", ".dll" } |
            ForEach-Object {
              & $signtool sign /fd SHA256 /sha1 $cert.Thumbprint $_.FullName
              if ($LASTEXITCODE -ne 0) {
                throw "Failed signing $($_.FullName)"
              }
            }

      - uses: actions/upload-artifact@v4
        with:
          name: signed_exedlls
          path: signed_exedlls

      - run: python src/scripts/build_lunatranslator.py repack

      - uses: actions/upload-artifact@v4
        with:
          name: signed
          path: signed


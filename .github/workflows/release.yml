name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  buildluna:
    uses: ./.github/workflows/buildluna.yml
    # with: 
    #   createrelease: true
    secrets: inherit
  
  loadversion:
    # if: ${{inputs.createrelease}}
    runs-on: windows-latest
    outputs:
      version: ${{ steps.loadversion.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: loadversion
        run: python src/scripts/build_lunatranslator.py loadversion | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Validate version
        shell: powershell
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ steps.loadversion.outputs.version }}")) {
            throw "Version is empty. Check build_lunatranslator.py loadversion output."
          }

  release:
    runs-on: windows-latest
    needs: [buildluna,loadversion]
    steps:
      - uses: actions/download-artifact@v4
        with:
            name: signed
            path: build/signed

      - name: Verify win10 x64 package exists
        shell: powershell
        run: |
          if (!(Test-Path "build/signed/LunaTranslator_x64_win10.zip")) {
            throw "Missing build/signed/LunaTranslator_x64_win10.zip"
          }

      - uses: softprops/action-gh-release@v2.2.2
        with:
          tag_name: ${{ needs.loadversion.outputs.version }}
          name: ${{ needs.loadversion.outputs.version }}
          generate_release_notes: true
          files: |
            build/signed/LunaTranslator_x64_win10.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
